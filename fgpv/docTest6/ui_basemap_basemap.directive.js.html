<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ui/basemap/basemap.directive.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="app.module_geo-LayerBlueprint.LayerBlueprint.html">LayerBlueprint</a></li><li><a href="app.module_geo-LayerFileBlueprint.html">LayerFileBlueprint</a><ul class='methods'><li data-type='method'><a href="app.module_geo-LayerFileBlueprint.html#_readFileData">_readFileData</a></li><li data-type='method'><a href="app.module_geo-LayerFileBlueprint.html#generateLayer">generateLayer</a></li><li data-type='method'><a href="app.module_geo-LayerFileBlueprint.html#validate">validate</a></li></ul></li><li><a href="app.module_geo-LayerServiceBlueprint.LayerServiceBlueprint.html">LayerServiceBlueprint</a></li><li><a href="LayerRecord.html">LayerRecord</a><ul class='methods'><li data-type='method'><a href="LayerRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="LayerRecord.html#createBbox">createBbox</a></li><li data-type='method'><a href="LayerRecord.html#destroyBbox">destroyBbox</a></li><li data-type='method'><a href="LayerRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="app.common.module_displayManager.html">app.common.displayManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_displayManager.html#~clearDisplayPanel">clearDisplayPanel</a></li><li data-type='method'><a href="app.common.module_displayManager.html#~setDisplay">setDisplay</a></li><li data-type='method'><a href="app.common.module_displayManager.html#~toggleDisplayPanel">toggleDisplayPanel</a></li></ul></li><li><a href="app.common.module_stateManager.html">app.common.stateManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_stateManager.html#~addState">addState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~callback">callback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~closePanel">closePanel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~closePanelFromHistory">closePanelFromHistory</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getChildren">getChildren</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getItem">getItem</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getParent">getParent</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~modifyHistory">modifyHistory</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~onCloseCallback">onCloseCallback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~openPanel">openPanel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~previousFocus">previousFocus</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~runCloseCallback">runCloseCallback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setActive">setActive</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setFocusElement">setFocusElement</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setItemProperty">setItemProperty</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMorph">setMorph</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setPanelFocus">setPanelFocus</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~togglePanel">togglePanel</a></li></ul></li><li><a href="app.core.module_common.html">app.core.common</a></li><li><a href="app.core.module_configService.html">app.core.configService</a><ul class='methods'><li data-type='method'><a href="app.core.module_configService.html#~currentLang">currentLang</a></li><li data-type='method'><a href="app.core.module_configService.html#~fileInit">fileInit</a></li><li data-type='method'><a href="app.core.module_configService.html#~getCurrent">getCurrent</a></li><li data-type='method'><a href="app.core.module_configService.html#~initialize">initialize</a></li><li data-type='method'><a href="app.core.module_configService.html#~mergeConfigParts">mergeConfigParts</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsAddKeys">rcsAddKeys</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsInit">rcsInit</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsLoad">rcsLoad</a></li><li data-type='method'><a href="app.core.module_configService.html#~ready">ready</a></li></ul></li><li><a href="app.geo.module_metadataService.html">app.geo.metadataService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_metadataService.html#.transformXml">transformXml</a></li></ul></li><li><a href="app.layout.module_layoutService.html">app.layout.layoutService</a></li><li><a href="app.layout.module_rvShell.html">app.layout.rvShell</a></li><li><a href="app.layout.module_storageService.html">app.layout.storageService</a></li><li><a href="app.module_common.html">app.common</a></li><li><a href="app.module_core.html">app.core</a></li><li><a href="app.module_geo.html">app.geo</a></li><li><a href="app.ui.common.module_stepper.html">app.ui.common.stepper</a></li><li><a href="app.ui.module_appbar.html">app.ui.appbar</a></li><li><a href="app.ui.module_basemap.html">app.ui.basemap</a></li><li><a href="app.ui.module_common.html">app.ui.common</a></li><li><a href="app.ui.module_details.html">app.ui.details</a></li><li><a href="app.ui.module_filters.html">app.ui.filters</a></li><li><a href="app.ui.module_help.html">app.ui.help</a></li><li><a href="app.ui.module_loader.html">app.ui.loader</a></li><li><a href="app.ui.module_mapnav.html">app.ui.mapnav</a></li><li><a href="app.ui.module_metadata.html">app.ui.metadata</a></li><li><a href="app.ui.module_panels.html">app.ui.panels</a></li><li><a href="app.ui.module_rvTocEntryControl.html">app.ui.rvTocEntryControl</a></li><li><a href="app.ui.module_settings.html">app.ui.settings</a></li><li><a href="app.ui.module_sidenav.html">app.ui.sidenav</a></li><li><a href="app.ui.module_toc.html">app.ui.toc</a></li><li><a href="app.ui.module_tocService.html">app.ui.tocService</a></li><li><a href="app.ui.module_toolbox.html">app.ui.toolbox</a></li><li><a href="material.components.menuBar.module_mdMenuItemDirectiveDecorator.html">material.components.menuBar.mdMenuItemDirectiveDecorator</a><ul class='methods'><li data-type='method'><a href="material.components.menuBar.module_mdMenuItemDirectiveDecorator.html#~decorateCompile">decorateCompile</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li><li><a href="app.common.html">app.common</a></li><li><a href="app.core.html">app.core</a><ul class='methods'><li data-type='method'><a href="app.core.html#.apiBlock">apiBlock</a></li><li data-type='method'><a href="app.core.html#.configBlock">configBlock</a></li><li data-type='method'><a href="app.core.html#.runBlock">runBlock</a></li><li data-type='method'><a href="app.core.html#.seed">seed</a></li><li data-type='method'><a href="app.core.html#~configureIconsets">configureIconsets</a></li><li data-type='method'><a href="app.core.html#~configureTheme">configureTheme</a></li><li data-type='method'><a href="app.core.html#~configureTranslations">configureTranslations</a></li><li data-type='method'><a href="app.core.html#~loadRcsLayers">loadRcsLayers</a></li><li data-type='method'><a href="app.core.html#~setLanguage">setLanguage</a></li></ul></li><li><a href="app.geo.html">app.geo</a></li><li><a href="app.layout.html">app.layout</a></li><li><a href="app.ui.html">app.ui</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-getting_started.html">Getting Started</a></li><li><a href="tutorial-gulp-i18n-csv.html">Translation Plugin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#RV">RV</a></li><li><a href="global.html#versionCheck">versionCheck</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">ui/basemap/basemap.directive.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(() => {
    'use strict';

    /**
     * @ngdoc directive
     * @name rvBasemap
     * @module app.ui.basemap
     * @restrict E
     * @description
     *
     * The `rvBasemap` directive displays a basemap selector. Its template uses a content pane which is loaded into the `other` panel opening on the right side of the screen. Selector groups basemaps by projection.
     *
     */
    angular
        .module('app.ui.basemap')
        .directive('rvBasemap', rvBasemap);

    function rvBasemap() {
        const directive = {
            restrict: 'E',
            templateUrl: 'app/ui/basemap/basemap.html',
            scope: {},
            link: link,
            controller: Controller,
            controllerAs: 'self',
            bindToController: true
        };

        return directive;

        /*********/

        function link() { // scope, el, attr, ctrl) {
        }
    }

    function Controller($rootScope, events, configService, geoService, reloadService) {
        'ngInject';
        const self = this;
        self.select = select;
        self.selectedWkid = null;

        // TODO: remove this; revise when config schema is finalized
        // mocking basemap part of the config
        // self.projections = [
        //     {
        //         wkid: 3978,
        //         name: 'Lambert',
        //         items: [
        // 'http://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBMT3978/MapServer',
        // 'http://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/Simple/MapServer',
        // 'http://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBME_CBCE_HS_RO_3978/MapServer',
        // 'http://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBMT_CBCT_GEOM_3978/MapServer'
        //         ]
        //     },
        //     {
        //         wkid: 102100,
        //         name: 'Mercator',
        //         items: [
        // 'http://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer',
        // 'http://services.arcgisonline.com/arcgis/rest/services/World_Physical_Map/MapServer',
        // 'http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer',
        // 'http://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer',
        // 'http://services.arcgisonline.com/arcgis/rest/services/World_Terrain_Base/MapServer'
        //         ]
        //     }
        // ];

        // TODO: code needs to be updated when config schema is stable
        // check to see if config service is ready
        // FIXME: clean up vars
        var promise = configService.ready();

        // run after configService is ready
        promise.then(() => {
            // construct self.projectsions using config
            console.log('Generate basemap object for rv-map directive.');

            self.projections = [];

            let useDefaultBasemap = true;

            $rootScope.$on(events.rvReady, () => {
                configService.getCurrent().then(config => {

                    [self.projections, useDefaultBasemap] = createLists(config);

                    // FIXME add appropriate safeguards for no basemaps, if not handled by fixme above.
                    try {
                        // select first basemap so UI displays it
                        if (useDefaultBasemap) {
                            self.projections[0].items[0].selected = true;

                            self.selectedWkid = self.projections[0].items[0].wkid;
                        }

                        const projections = self.projections;

                        projections.forEach(projection => {
                            const items = projection.items;

                            items.forEach(item => {
                                item.needMapRefresh = (self.selectedWkid !== item.wkid);
                            });

                        });

                    } catch (e) {
                        // no basemaps. ignore :'D
                    }

                    self.projections.forEach(projection => {
                        // get the wkid from the first
                        const wkid = projection.items[0].wkid;

                        // add blank map
                        projection.items.push({
                            name: 'blank map',
                            description: 'Remove base map',
                            type: 'blank',
                            id: 'blank_basemap_' + wkid,
                            url: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7/',
                            wkid: wkid,
                            selected: false
                        });
                    });

                    // console.log(basemaps);
                });
            });

        });

        activate();

        /*********/

        function activate() {

        }

        /**
         * Set the basemap as selected
         * @param  {object} basemap basemap object
         */
        function select(basemap) {

            // un-select the previous basemap
            self.projections.forEach(projection => {
                projection.items.forEach(item => {
                    item.needMapRefresh = (basemap.wkid === item.wkid) ? false : true;
                    item.selected = false;
                });
            });

            // set the selected wkid
            self.selectedWkid = basemap.wkid;

            // set the current basemap as selected.
            basemap.selected = true;

            if (geoService.baseMapHasSameSP(basemap.id)) {

                // set the selected basemap
                geoService.selectBasemap(basemap.id);
            } else {
                console.log('-- reload map --');
                reloadService.loadNewProjection(basemap.id);
            }

        }

        /**
         * Create the lists of basemaps from the config.
         *
         * @param {Object} config   Config containing basemaps for the viewer
         * @returns {Array}         Returns the lists and the "useDefaultBasemap" flag as an array in that order
         */
        function createLists(config) {
            // FIXME: in case there is no basemaps; fall back to some default one or something
            const basemaps = config.baseMaps || [];
            const projections = [];
            let wkidArray = [];
            let useDefaultBasemap = true;

            basemaps.forEach(basemap => {

                // make new projection if not exists
                var wkid = basemap.wkid;
                var idx;

                if (wkidArray.indexOf(wkid) !== -1) {
                    console.log('in if wkidArray');
                    idx = wkidArray.indexOf(wkid);
                } else {

                    // TODO: decision needed on how we handle different type of projection,
                    // adding all of them here, or it won't be an issue if we predefine all
                    // in config.
                    projections.push({
                        wkid: wkid,
                        name: (wkid === 3978) ? 'Lambert' :
                            (wkid === 102100) ? 'Mercator' : 'Other',
                        items: []
                    });

                    wkidArray.push(wkid);

                    idx = wkidArray.indexOf(wkid);
                }

                // FIXME: move to config?
                const maxLength = 35;

                if (basemap.name.length > maxLength) {
                    basemap.name = basemap.name.substring(0, maxLength - 3) + '...';
                }

                let selected = false;

                if (config.map &amp;&amp; config.map.initialBasemapId) {
                    if (config.map.initialBasemapId === basemap.id) {
                        selected = true;
                        useDefaultBasemap = false;

                        self.selectedWkid = basemap.wkid;
                    }
                }

                projections[idx].items.push({
                    name: basemap.name,
                    description: basemap.description,
                    type: basemap.type,
                    id: basemap.id,
                    url: basemap.layers[0].url,
                    wkid: basemap.wkid,
                    selected: selected,
                    needMapRefresh: false
                });

            });

            return [projections, useDefaultBasemap];
        }
    }
})();
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Jul 09 2016 18:43:25 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
