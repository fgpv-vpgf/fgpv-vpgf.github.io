<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>geo/layer-registry.service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="app.geo.module_identifyService-IDENTIFY_RESULT.html">IDENTIFY_RESULT</a></li><li><a href="app.geo.module_LayerBlueprintFactory-LayerBlueprint.LayerBlueprint.html">LayerBlueprint</a></li><li><a href="app.geo.module_LayerBlueprintFactory-LayerFileBlueprint.html">LayerFileBlueprint</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerBlueprintFactory-LayerFileBlueprint.html#_readFileData">_readFileData</a></li><li data-type='method'><a href="app.geo.module_LayerBlueprintFactory-LayerFileBlueprint.html#generateLayer">generateLayer</a></li><li data-type='method'><a href="app.geo.module_LayerBlueprintFactory-LayerFileBlueprint.html#validate">validate</a></li></ul></li><li><a href="app.geo.module_LayerBlueprintFactory-LayerServiceBlueprint.LayerServiceBlueprint.html">LayerServiceBlueprint</a></li><li><a href="app.geo.module_LayerRecordFactory-AttrRecord.html">AttrRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-AttrRecord.html#formatAttributes">formatAttributes</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-AttrRecord.html#getAttributes">getAttributes</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-DynamicRecord.html">DynamicRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-DynamicRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-DynamicRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-FeatureRecord.html">FeatureRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-FeatureRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-FeatureRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-ImageRecord.html">ImageRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-ImageRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-ImageRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-LayerRecord.html">LayerRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-LayerRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-LayerRecord.html#createBbox">createBbox</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-LayerRecord.html#destroyBbox">destroyBbox</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-LayerRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-LayerRecord.LayerRecord.html">LayerRecord</a></li><li><a href="app.geo.module_LayerRecordFactory-TileRecord.html">TileRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-TileRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-TileRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.geo.module_LayerRecordFactory-WmsRecord.html">WmsRecord</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory-WmsRecord.html#.parseData">parseData</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory-WmsRecord.html#makeLayerBookmark">makeLayerBookmark</a></li></ul></li><li><a href="app.ui.module_StepperFactory-Stepper.html">Stepper</a><ul class='methods'><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#_configureStep">_configureStep</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#_reset">_reset</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#_think">_think</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#addSteps">addSteps</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#cancelMove">cancelMove</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#moveToStep">moveToStep</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#nextStep">nextStep</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#previousStep">previousStep</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#reset">reset</a></li><li data-type='method'><a href="app.ui.module_StepperFactory-Stepper.html#start">start</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="app.common.module_displayManager.html">app.common.displayManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_displayManager.html#~clearDisplayPanel">clearDisplayPanel</a></li><li data-type='method'><a href="app.common.module_displayManager.html#~setDisplay">setDisplay</a></li><li data-type='method'><a href="app.common.module_displayManager.html#~toggleDisplayPanel">toggleDisplayPanel</a></li></ul></li><li><a href="app.common.module_stateManager.html">app.common.stateManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_stateManager.html#~addState">addState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~callback">callback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~closePanel">closePanel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~closePanelFromHistory">closePanelFromHistory</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getChildren">getChildren</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getItem">getItem</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getParent">getParent</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~modifyHistory">modifyHistory</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~onCloseCallback">onCloseCallback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~openPanel">openPanel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~previousFocus">previousFocus</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~runCloseCallback">runCloseCallback</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setActive">setActive</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setFocusElement">setFocusElement</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setItemProperty">setItemProperty</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMorph">setMorph</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setPanelFocus">setPanelFocus</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~togglePanel">togglePanel</a></li></ul></li><li><a href="app.core.module_common.html">app.core.common</a></li><li><a href="app.core.module_configService.html">app.core.configService</a><ul class='methods'><li data-type='method'><a href="app.core.module_configService.html#~currentLang">currentLang</a></li><li data-type='method'><a href="app.core.module_configService.html#~fileInit">fileInit</a></li><li data-type='method'><a href="app.core.module_configService.html#~getCurrent">getCurrent</a></li><li data-type='method'><a href="app.core.module_configService.html#~initialize">initialize</a></li><li data-type='method'><a href="app.core.module_configService.html#~mergeConfigParts">mergeConfigParts</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsAddKeys">rcsAddKeys</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsInit">rcsInit</a></li><li data-type='method'><a href="app.core.module_configService.html#~rcsLoad">rcsLoad</a></li><li data-type='method'><a href="app.core.module_configService.html#~ready">ready</a></li></ul></li><li><a href="app.geo.module_gapiService.html">app.geo.gapiService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_gapiService.html#~init">init</a></li></ul></li><li><a href="app.geo.module_Geo.html">app.geo.Geo</a></li><li><a href="app.geo.module_geoService.html">app.geo.geoService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_geoService.html#~assembleMap">assembleMap</a></li><li data-type='method'><a href="app.geo.module_geoService.html#~epsgLookup">epsgLookup</a></li></ul></li><li><a href="app.geo.module_identifyService.html">app.geo.identifyService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_identifyService.html#~attributesToDetails">attributesToDetails</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~clickHandlerBuilder">clickHandlerBuilder</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~getFeatureName">getFeatureName</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~identifyEsriDynamicLayer">identifyEsriDynamicLayer</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~identifyEsriFeatureLayer">identifyEsriFeatureLayer</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~identifyOgcWmsLayer">identifyOgcWmsLayer</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~init">init</a></li><li data-type='method'><a href="app.geo.module_identifyService.html#~makeInfalliblePromise">makeInfalliblePromise</a></li></ul></li><li><a href="app.geo.module_LayerBlueprintFactory.html">app.geo.LayerBlueprintFactory</a></li><li><a href="app.geo.module_LayerBlueprintUserOptions.html">app.geo.LayerBlueprintUserOptions</a></li><li><a href="app.geo.module_LayerRecordFactory.html">app.geo.LayerRecordFactory</a><ul class='methods'><li data-type='method'><a href="app.geo.module_LayerRecordFactory.html#~makeFileRecord">makeFileRecord</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory.html#~makeServiceRecord">makeServiceRecord</a></li><li data-type='method'><a href="app.geo.module_LayerRecordFactory.html#~parseLayerData">parseLayerData</a></li></ul></li><li><a href="app.geo.module_layerRegistry.html">app.geo.layerRegistry</a><ul class='methods'><li data-type='method'><a href="app.geo.module_layerRegistry.html#~_refactorIsLayerInMapStack">_refactorIsLayerInMapStack</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~_testSyncCheck">_testSyncCheck</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~aliasedFieldName">aliasedFieldName</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~checkDateType">checkDateType</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~constructLayers">constructLayers</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~extentChangeHandler">extentChangeHandler</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~getAllQueryableLayerRecords">getAllQueryableLayerRecords</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~getLayerInsertPosition">getLayerInsertPosition</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~getLayerMapIndex">getLayerMapIndex</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~getLayersByType">getLayersByType</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~isOffScale">isOffScale</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~makeScaleSet">makeScaleSet</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~moveLayer">moveLayer</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~registerLayerRecord">registerLayerRecord</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~reloadLayer">reloadLayer</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~removeLayer">removeLayer</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~setBboxState">setBboxState</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~setScaleDepState">setScaleDepState</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~snapshotLayer">snapshotLayer</a></li><li data-type='method'><a href="app.geo.module_layerRegistry.html#~zoomToScale">zoomToScale</a></li></ul></li><li><a href="app.geo.module_legendEntryFactory.html">app.geo.legendEntryFactory</a></li><li><a href="app.geo.module_legendService.html">app.geo.legendService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_legendService.html#~addLayer">addLayer</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~addPlaceholder">addPlaceholder</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~applyFeatureCount">applyFeatureCount</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~applySymbology">applySymbology</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~autoLegendService">autoLegendService</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~dynamicGenerator">dynamicGenerator</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~featureGenerator">featureGenerator</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~getMapServerSymbology">getMapServerSymbology</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~getServiceFeatureCount">getServiceFeatureCount</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~imageGenerator">imageGenerator</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~tileGenerator">tileGenerator</a></li><li data-type='method'><a href="app.geo.module_legendService.html#~wmsGenerator">wmsGenerator</a></li></ul></li><li><a href="app.geo.module_mapService.html">app.geo.mapService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_mapService.html#~applyHilight">applyHilight</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~baseMapHasSameSP">baseMapHasSameSP</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~buildMapObject">buildMapObject</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~clearHilight">clearHilight</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~dropMapPin">dropMapPin</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~fetchGraphic">fetchGraphic</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~fetchLocation">fetchLocation</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~geolocate">geolocate</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~getBaseMapConfig">getBaseMapConfig</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~getFullExtFromExtentSets">getFullExtFromExtentSets</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~getLod">getLod</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~hideBaseMap">hideBaseMap</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~hilightGraphic">hilightGraphic</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~prepMapLoad">prepMapLoad</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~retrieveSymbol">retrieveSymbol</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~selectBasemap">selectBasemap</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~setFullExtent">setFullExtent</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~setMapLoadingFlag">setMapLoadingFlag</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~setSelectedBaseMap">setSelectedBaseMap</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~setZoom">setZoom</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~shiftZoom">shiftZoom</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~zoomToGraphic">zoomToGraphic</a></li><li data-type='method'><a href="app.geo.module_mapService.html#~zoomWithOffset">zoomWithOffset</a></li></ul></li><li><a href="app.geo.module_metadataService.html">app.geo.metadataService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_metadataService.html#.transformXml">transformXml</a></li><li data-type='method'><a href="app.geo.module_metadataService.html#~applyXSLT">applyXSLT</a></li><li data-type='method'><a href="app.geo.module_metadataService.html#~loadXmlFile">loadXmlFile</a></li></ul></li><li><a href="app.geo.module_rvInitMap.html">app.geo.rvInitMap</a></li><li><a href="app.layout.module_layoutService.html">app.layout.layoutService</a></li><li><a href="app.layout.module_rvShell.html">app.layout.rvShell</a></li><li><a href="app.layout.module_storageService.html">app.layout.storageService</a></li><li><a href="app.module_core.html">app.core</a></li><li><a href="app.module_ui.html">app.ui</a><ul class='methods'><li data-type='method'><a href="app.module_ui.html#~closeLoaderService">closeLoaderService</a></li><li data-type='method'><a href="app.module_ui.html#~configureOnContinue">configureOnContinue</a></li><li data-type='method'><a href="app.module_ui.html#~configureReset">configureReset</a></li><li data-type='method'><a href="app.module_ui.html#~connectOnContinue">connectOnContinue</a></li><li data-type='method'><a href="app.module_ui.html#~connectReset">connectReset</a></li><li data-type='method'><a href="app.module_ui.html#~onCancel">onCancel</a></li><li data-type='method'><a href="app.module_ui.html#~selectOnContinue">selectOnContinue</a></li><li data-type='method'><a href="app.module_ui.html#~serviceUrlResetValidation">serviceUrlResetValidation</a></li><li data-type='method'><a href="app.module_ui.html#~toggleErrorMessage">toggleErrorMessage</a></li></ul></li><li><a href="app.ui.basemap.module_rvBasemap.html">app.ui.basemap.rvBasemap</a><ul class='methods'><li data-type='method'><a href="app.ui.basemap.module_rvBasemap.html#~createLists">createLists</a></li><li data-type='method'><a href="app.ui.basemap.module_rvBasemap.html#~select">select</a></li></ul></li><li><a href="app.ui.module_errorService.html">app.ui.errorService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_errorService.html#~display">display</a></li><li data-type='method'><a href="app.ui.module_errorService.html#~remove">remove</a></li></ul></li><li><a href="app.ui.module_fullScreenService.html">app.ui.fullScreenService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_fullScreenService.html#~onComplete">onComplete</a></li><li data-type='method'><a href="app.ui.module_fullScreenService.html#~toggle">toggle</a></li></ul></li><li><a href="app.ui.module_helpService.html">app.ui.helpService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_helpService.html#~clearDrawn">clearDrawn</a></li><li data-type='method'><a href="app.ui.module_helpService.html#~register">register</a></li><li data-type='method'><a href="app.ui.module_helpService.html#~setDrawn">setDrawn</a></li><li data-type='method'><a href="app.ui.module_helpService.html#~unregister">unregister</a></li></ul></li><li><a href="app.ui.module_mapNavigationService.html">app.ui.mapNavigationService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_mapNavigationService.html#~mapNavigationService">mapNavigationService</a></li></ul></li><li><a href="app.ui.module_rvAppbar.html">app.ui.rvAppbar</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvAppbar.html#~rvAppbar">rvAppbar</a></li></ul></li><li><a href="app.ui.module_rvBasemapItem.html">app.ui.rvBasemapItem</a></li><li><a href="app.ui.module_rvContentPane.html">app.ui.rvContentPane</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvContentPane.html#~addHeaderControl">addHeaderControl</a></li><li data-type='method'><a href="app.ui.module_rvContentPane.html#~link">link</a></li><li data-type='method'><a href="app.ui.module_rvContentPane.html#~rvContentPane">rvContentPane</a></li></ul></li><li><a href="app.ui.module_rvDetails.html">app.ui.rvDetails</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvDetails.html#~closeDetails">closeDetails</a></li><li data-type='method'><a href="app.ui.module_rvDetails.html#~getSelectedItem">getSelectedItem</a></li><li data-type='method'><a href="app.ui.module_rvDetails.html#~selectItem">selectItem</a></li></ul></li><li><a href="app.ui.module_rvDetailsContent.html">app.ui.rvDetailsContent</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvDetailsContent.html#~rvDetailsContent">rvDetailsContent</a></li></ul></li><li><a href="app.ui.module_rvDetailsExpand.html">app.ui.rvDetailsExpand</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvDetailsExpand.html#~rvDetailsExpand">rvDetailsExpand</a></li></ul></li><li><a href="app.ui.module_rvDetailsRecordEsrifeature.html">app.ui.rvDetailsRecordEsrifeature</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvDetailsRecordEsrifeature.html#~renderDetails">renderDetails</a></li><li data-type='method'><a href="app.ui.module_rvDetailsRecordEsrifeature.html#~toggleDetails">toggleDetails</a></li><li data-type='method'><a href="app.ui.module_rvDetailsRecordEsrifeature.html#~zoomToFeature">zoomToFeature</a></li></ul></li><li><a href="app.ui.module_rvDetailsRecordHtml.html">app.ui.rvDetailsRecordHtml</a></li><li><a href="app.ui.module_rvDetectScrollbar.html">app.ui.rvDetectScrollbar</a></li><li><a href="app.ui.module_rvDragula.html">app.ui.rvDragula</a></li><li><a href="app.ui.module_rvFiltersDefault.html">app.ui.rvFiltersDefault</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~addColumnInteractivity">addColumnInteractivity</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~Controller">Controller</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~createTable">createTable</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~destroyTable">destroyTable</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~link">link</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~rvFiltersDefault">rvFiltersDefault</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefault.html#~triggerTableButton">triggerTableButton</a></li></ul></li><li><a href="app.ui.module_rvFiltersDefaultMenu.html">app.ui.rvFiltersDefaultMenu</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvFiltersDefaultMenu.html#~dataExportCSVTODO:eschewevents;neededheresinceit'sveryhardtocommunicatewithmainfiltersdirective;angular1.5shouldsolveitusingdirectiveswithmultipletransclusions">dataExportCSV
TODO: eschew events; needed here since it's very hard to communicate with main filters directive; angular 1.5 should solve it using directives with multiple transclusions</a></li><li data-type='method'><a href="app.ui.module_rvFiltersDefaultMenu.html#~dataPrintTODO:eschewevents;neededheresinceit'sveryhardtocommunicatewithmainfiltersdirective;angular1.5shouldsolveitusingdirectiveswithmultipletransclusions">dataPrint
TODO: eschew events; needed here since it's very hard to communicate with main filters directive; angular 1.5 should solve it using directives with multiple transclusions</a></li></ul></li><li><a href="app.ui.module_rvFiltersPanel.html">app.ui.rvFiltersPanel</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvFiltersPanel.html#~closePanelFIXME:thisshouldbehandledintheshatehelper">closePanel
FIXME: this should be handled in the shatehelper</a></li><li data-type='method'><a href="app.ui.module_rvFiltersPanel.html#~Controller">Controller</a></li><li data-type='method'><a href="app.ui.module_rvFiltersPanel.html#~rvPanel">rvPanel</a></li></ul></li><li><a href="app.ui.module_rvHelpOverlay.html">app.ui.rvHelpOverlay</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvHelpOverlay.html#~draw">draw</a></li><li data-type='method'><a href="app.ui.module_rvHelpOverlay.html#~overlap">overlap</a></li><li data-type='method'><a href="app.ui.module_rvHelpOverlay.html#~shouldBeDrawn">shouldBeDrawn</a></li></ul></li><li><a href="app.ui.module_rvLayerItemSymbology.html">app.ui.rvLayerItemSymbology</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvLayerItemSymbology.html#~getTextWidth">getTextWidth</a></li><li data-type='method'><a href="app.ui.module_rvLayerItemSymbology.html#~iconLegendItem">iconLegendItem</a></li><li data-type='method'><a href="app.ui.module_rvLayerItemSymbology.html#~imageLegendItem">imageLegendItem</a></li></ul></li><li><a href="app.ui.module_rvLayerListSlider.html">app.ui.rvLayerListSlider</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvLayerListSlider.html#~animateClosed">animateClosed</a></li><li data-type='method'><a href="app.ui.module_rvLayerListSlider.html#~animateOpen">animateOpen</a></li><li data-type='method'><a href="app.ui.module_rvLayerListSlider.html#~itemSelectedByKeypress">itemSelectedByKeypress</a></li><li data-type='method'><a href="app.ui.module_rvLayerListSlider.html#~itemSelectedByMouse">itemSelectedByMouse</a></li></ul></li><li><a href="app.ui.module_rvLoaderFile.html">app.ui.rvLoaderFile</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~closeLoaderFile">closeLoaderFile</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~configureOnContinue">configureOnContinue</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~fileReset">fileReset</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~fileResetValidation">fileResetValidation</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~fileUrlReset">fileUrlReset</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~fileUrlResetValidation">fileUrlResetValidation</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~onCancel">onCancel</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~onLayerBlueprintReady">onLayerBlueprintReady</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~selectOnContinue">selectOnContinue</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~selectReset">selectReset</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~selectResetValidation">selectResetValidation</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~toggleErrorMessage">toggleErrorMessage</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~updateProgress">updateProgress</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~uploadFilesSubmitted">uploadFilesSubmitted</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~uploadOnContinue">uploadOnContinue</a></li><li data-type='method'><a href="app.ui.module_rvLoaderFile.html#~uploadReset">uploadReset</a></li></ul></li><li><a href="app.ui.module_rvLoaderMenu.html">app.ui.rvLoaderMenu</a></li><li><a href="app.ui.module_rvMapnav.html">app.ui.rvMapnav</a></li><li><a href="app.ui.module_rvMapnavButton.html">app.ui.rvMapnavButton</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvMapnavButton.html#~rvMapnavButton">rvMapnavButton</a></li></ul></li><li><a href="app.ui.module_rvMenuLink.html">app.ui.rvMenuLink</a></li><li><a href="app.ui.module_rvMetadataContent.html">app.ui.rvMetadataContent</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvMetadataContent.html#~rvMetadataContent">rvMetadataContent</a></li></ul></li><li><a href="app.ui.module_rvMetadataExpand.html">app.ui.rvMetadataExpand</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvMetadataExpand.html#~rvMetadataExpand">rvMetadataExpand</a></li></ul></li><li><a href="app.ui.module_rvMetadataPanel.html">app.ui.rvMetadataPanel</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvMetadataPanel.html#~rvMetadataPanel">rvMetadataPanel</a></li></ul></li><li><a href="app.ui.module_rvMorph.html">app.ui.rvMorph</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvMorph.html#~linkFunc">linkFunc</a></li><li data-type='method'><a href="app.ui.module_rvMorph.html#~rvMorph">rvMorph</a></li></ul></li><li><a href="app.ui.module_rvPlugSlide.html">app.ui.rvPlugSlide</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~animationBuilder">animationBuilder</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~buildTween">buildTween</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~calculateShift">calculateShift</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~cleanup">cleanup</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~deltaHelper">deltaHelper</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~getPanelSize">getPanelSize</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~makeFadeAnim">makeFadeAnim</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~makeSlideAnim">makeSlideAnim</a></li><li data-type='method'><a href="app.ui.module_rvPlugSlide.html#~ngShowHideWrapper">ngShowHideWrapper</a></li></ul></li><li><a href="app.ui.module_rvReverse.html">app.ui.rvReverse</a></li><li><a href="app.ui.module_rvSettings.html">app.ui.rvSettings</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvSettings.html#~rvSettings">rvSettings</a></li><li data-type='method'><a href="app.ui.module_rvSettings.html#~toggleQuery">toggleQuery</a></li></ul></li><li><a href="app.ui.module_rvStepperItem.html">app.ui.rvStepperItem</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvStepperItem.html#~onCancelBefore">onCancelBefore</a></li></ul></li><li><a href="app.ui.module_rvToc.html">app.ui.rvToc</a></li><li><a href="app.ui.module_rvTocEntry.html">app.ui.rvTocEntry</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvTocEntry.html#~link">link</a></li></ul></li><li><a href="app.ui.module_rvTocEntryControl.html">app.ui.rvTocEntryControl</a></li><li><a href="app.ui.module_rvTocEntryFlag.html">app.ui.rvTocEntryFlag</a></li><li><a href="app.ui.module_rvToggleSlide.html">app.ui.rvToggleSlide</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvToggleSlide.html#~getTargetHeight">getTargetHeight</a></li><li data-type='method'><a href="app.ui.module_rvToggleSlide.html#~ngShowHideBootstrap">ngShowHideBootstrap</a></li><li data-type='method'><a href="app.ui.module_rvToggleSlide.html#~toggleClose">toggleClose</a></li><li data-type='method'><a href="app.ui.module_rvToggleSlide.html#~toggleOpen">toggleOpen</a></li></ul></li><li><a href="app.ui.module_rvToolbox.html">app.ui.rvToolbox</a></li><li><a href="app.ui.module_rvTruncate.html">app.ui.rvTruncate</a><ul class='methods'><li data-type='method'><a href="app.ui.module_rvTruncate.html#~rvTruncate">rvTruncate</a></li></ul></li><li><a href="app.ui.module_sideNavigationService.html">app.ui.sideNavigationService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_sideNavigationService.html#~close">close</a></li><li data-type='method'><a href="app.ui.module_sideNavigationService.html#~open">open</a></li><li data-type='method'><a href="app.ui.module_sideNavigationService.html#~toggle">toggle</a></li></ul></li><li><a href="app.ui.module_StepperFactory.html">app.ui.StepperFactory</a></li><li><a href="app.ui.module_tocService.html">app.ui.tocService</a><ul class='methods'><li data-type='method'><a href="app.ui.module_tocService.html#~removeLayer">removeLayer</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~setTocEntrySelectedState">setTocEntrySelectedState</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~toggleLayerFiltersPanel">toggleLayerFiltersPanel</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~toggleMetadata">toggleMetadata</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~toggleSettings">toggleSettings</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~watchPanelState">watchPanelState</a></li><li data-type='method'><a href="app.ui.module_tocService.html#~zoomLayerScale">zoomLayerScale</a></li></ul></li><li><a href="material.components.menuBar.module_mdMenuItemDirectiveDecorator.html">material.components.menuBar.mdMenuItemDirectiveDecorator</a><ul class='methods'><li data-type='method'><a href="material.components.menuBar.module_mdMenuItemDirectiveDecorator.html#~decorateCompile">decorateCompile</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li><li><a href="app.common.html">app.common</a></li><li><a href="app.core.html">app.core</a><ul class='methods'><li data-type='method'><a href="app.core.html#.apiBlock">apiBlock</a></li><li data-type='method'><a href="app.core.html#.configBlock">configBlock</a></li><li data-type='method'><a href="app.core.html#.runBlock">runBlock</a></li><li data-type='method'><a href="app.core.html#.seed">seed</a></li><li data-type='method'><a href="app.core.html#~configureIconsets">configureIconsets</a></li><li data-type='method'><a href="app.core.html#~configureTheme">configureTheme</a></li><li data-type='method'><a href="app.core.html#~configureTranslations">configureTranslations</a></li><li data-type='method'><a href="app.core.html#~loadRcsLayers">loadRcsLayers</a></li><li data-type='method'><a href="app.core.html#~setLanguage">setLanguage</a></li></ul></li><li><a href="app.geo.html">app.geo</a></li><li><a href="app.layout.html">app.layout</a></li><li><a href="app.ui.html">app.ui</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-getting_started.html">Getting Started</a></li><li><a href="tutorial-gulp-i18n-csv.html">Translation Plugin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#RV">RV</a></li><li><a href="global.html#versionCheck">versionCheck</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">geo/layer-registry.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(() => {
    'use strict';

    /**
     * @ngdoc service
     * @module layerRegistry
     * @memberof app.geo
     * @requires gapiService
     * @requires mapService
     * @requires layerTypes
     * @requires configDefaults
     * @description
     *
     * The `layerRegistry` factory tracks active layers and constructs legend, provide all layer-related functionality like registering, removing, changing visibility, changing opacity, etc.
     *
     */
    angular
        .module('app.geo')
        .factory('layerRegistry', layerRegistryFactory);

    function layerRegistryFactory($q, $timeout, gapiService, legendService, Geo) {

        return (geoState, config) => layerRegistry(geoState, geoState.mapService.mapObject, config);

        function layerRegistry(geoState, mapObject, config) {

            const layers = {};

            // this `service` object will be exposed through `geoService`
            const service = {
                /**
                 * Reference to the map legend
                 * @member legend
                 */
                legend: null,
                /**
                 * Collection of LayerRecord objects.  Maps `LayerRecord.id` -> `LayerRecord`.
                 * @see LayerRecord
                 * @member layers
                 */
                layers,

                constructLayers,
                removeLayer,
                zoomToScale,
                reloadLayer,
                snapshotLayer,
                aliasedFieldName,
                getLayersByType,
                getAllQueryableLayerRecords,
                moveLayer,
                checkDateType,
                setBboxState,
                getLayerMapIndex,
                _refactorIsLayerInMapStack // temporary function, will likely be removed after refactor
            };

            const ref = {
                legendService: legendService(config, service)
            };

            service.legend = ref.legendService.legend;

            // for debug purposes
            // FIXME: add a debug flag which controls if these should be bound
            window.RV.debug = {};
            window.RV.debug.layers = service.layers;
            window.RV.debug.legend = service.legend;
            window.RV.debug.graphicsLayerIds = mapObject.graphicsLayerIds;
            window.RV.debug.layerIds = mapObject.layerIds;
            window.RV.debug.geoState = geoState;
            window.RV.debug.gapi = gapiService.gapi;

            // set event handler for extent changes
            gapiService.gapi.events.wrapEvents(
                geoState.mapService.mapObject,
                {
                    'extent-change': extentChangeHandler
                }
            );

            // store service in geoState
            geoState.layerRegistry = service;

            return service;

            /***/

            /**
             * Checks whether the supplied layer id is in the map stack;
             * This should be not needed after state machine refactor;
             * @function _refactorIsLayerInMapStack
             * @private
             * @param  {Number}  layerId   layer id
             * @param  {Number}  sortGroup layer sort group
             * @return {Boolean}           indicates if the layer is in the map stack
             */
            function _refactorIsLayerInMapStack(layerId, sortGroup) {
                const mapStackSwitch = [
                    mapObject.graphicsLayerIds,
                    mapObject.layerIds
                ];

                return mapStackSwitch[sortGroup].indexOf(layerId.replace('placeholder', '')) !== -1;
            }

            /**
             * Retrieves all layer records of the specified type.
             * @function getLayersByType
             * @param {String} layerType the type of layer to be filtered
             * @return {Array} array of  layer records
             */
            function getLayersByType(layerType) {
                return Object.keys(layers).map(key => layers[key])
                    .filter(lr => lr.config.layerType === layerType);
            }

            // FIXME  add a check to see if layer has config setting for not supporting a click
            /**
             * Retrieves all queryable layer records.
             * First filters for all queryable layers, then filters for layers which are
             * in a valid state.
             * @function getAllQueryableLayerRecords
             * @return {Array} array of layer records
             */
            function getAllQueryableLayerRecords() {
                return Object.keys(layers).map(key => layers[key])
                    .filter(layerRecord => Geo.Layer.QUERYABLE.indexOf(layerRecord.config.layerType) !== -1)
                    .filter(layerRecord => layerRecord.state !== Geo.Layer.States.ERROR);
            }

            /**
             * Handler for map extent change.
             * @function extentChangeHandler
             * @private
             * @param  {Object} params event parameters
             */
            function extentChangeHandler(params) {
                geoState.mapService.clearHilight();
                if (params.levelChange) {
                    // refresh scale state of all layers
                    Object.keys(service.layers).forEach(layerId => {
                        setScaleDepState(layerId);
                    });
                }
            }

            /**
             * Update scale status of a layer.
             * @function setScaleDepState
             * @private
             * @param  {String} layerId       layer id of layer to update
             */
            function setScaleDepState(layerId) {
                const lr = service.layers[layerId];
                makeScaleSet(lr).then(scaleSet => lr.legendEntry.setLayerScaleFlag(scaleSet));
            }

            /**
             * Determines if a scale is outside the given bounds.
             * @function isOffScale
             * @private
             * @param  {Integer} scale           scale value to test
             * @param  {Integer} minScale        minimum invalid scale level for zoom out, 0 for none
             * @param  {Integer} maxScale        maximum invalid scale level for zoom in, 0 for none
             * @return {Object}                  scaleSet.value = true if scale is outside valid bound
             */
            function isOffScale(scale, minScale, maxScale) {
                // GIS for dummies.
                // scale increases as you zoom out, decreases as you zoom in
                // minScale means if you zoom out beyond this number, hide the layer
                // maxScale means if you zoom in past this number, hide the layer
                // 0 value for min or max scale means there is no hiding in effect
                const scaleSet = {
                    value: false,
                    zoomIn: false
                };

                // check if out of scale and set zoom direction to scaleSet
                if (scale &lt; maxScale &amp;&amp; maxScale !== 0) {
                    scaleSet.value = true;
                    scaleSet.zoomIn = false;
                } else if (scale > minScale &amp;&amp; minScale !== 0) {
                    scaleSet.value = true;
                    scaleSet.zoomIn = true;
                }

                return scaleSet;
            }

            /**
             * Generate a mapping of feature indexes to off-scale status for a layer.
             * @function makeScaleSet
             * @private
             * @param  {Object} layerRecord   a LayerRecord object
             * @return {Promise}              resolves with mapping of layer indexes to boolean off-scale status
             */
            function makeScaleSet(layerRecord) {

                const currScale = geoState.mapService.mapObject.getScale();
                const result = {};
                const promises = []; // list of promises that must resolve before we are ready

                // TODO will likely need to adjust logic to take WMS/OpenFormat layers scale properties
                if (layerRecord.attributeBundle &amp;&amp; layerRecord.attributeBundle.indexes) {
                    // attributes were loaded for this layer. iterate through all sublayers in the bundle
                    layerRecord.attributeBundle.indexes.forEach(featureIdx => {
                        // wait for medatadata to load, then calculate the scale
                        promises.push(layerRecord.attributeBundle[featureIdx].layerData.then(layerData => {
                            result[featureIdx] = isOffScale(currScale, layerData.minScale, layerData.maxScale);
                        }));

                    });
                } else {
                    // grab min and max from layer itself, use zero as featureIdx
                    result['0'] = isOffScale(currScale, layerRecord._layer.minScale, layerRecord._layer.maxScale);
                }

                // promise of result that resovles after all promises[] resolve
                return $q.all(promises).then(() => result);
            }

            /**
             * Given a LayerRecord find the position it currently occupies within the map.
             * @function getLayerMapIndex
             * @param {LayerRecord} layerRecord
             * @return {Number} An integer specifying the position of the layer within the appropriate ESRI map stack
             */
            function getLayerMapIndex(layerRecord) {
                const mapStackSwitch = [mapObject.graphicsLayerIds, mapObject.layerIds];
                return mapStackSwitch[layerRecord.legendEntry.sortGroup].indexOf(layerRecord.layerId);
            }

            /**
             * Finds a position at which to insert the source layer so it's positioned directly above target layer (if one specified).
             * If the target layer is no specified, the source layer is placed at the bottom of its sort group.
             *
             * NOTE the ESRI map stack does not reflect the legend and is arranged in reverse order
             * for ESRI low index = low drawing order; legend: low index = high drawing order.
             * See design notes in https://github.com/fgpv-vpgf/fgpv-vpgf/issues/514 for more details.
             *
             * @function getLayerInsertPosition
             * @param {String} sourceId the id of the layer to be moved
             * @param {String} targetId the id of the layer the target layer will be moved on top of; can be -1, if its the end of the list
             * @return {Number}          index at which the source layer should be inserted in the map stack
             */
            function getLayerInsertPosition(sourceId, targetId) {
                const sourceEntry = service.layers[sourceId].legendEntry;
                const targetEntry = typeof targetId !== 'undefined' ? service.layers[targetId].legendEntry : null;
                const mapStackSwitch = [mapObject.graphicsLayerIds, mapObject.layerIds];

                const sourceIndex = getLayerMapIndex(service.layers[sourceId]);
                let targetIndex;

                // if targetEntry is null, meaning the layer is dropped at the end of the list or
                // the layer is dropped on top of a different group
                if (targetEntry === null || sourceEntry.sortGroup !== targetEntry.sortGroup) {
                    // put the layer at the bottom of its sort group on top of any unregistered layers (basemap layers)
                    // this finds the first layer which is in the map stack and not registered (basemap layer)
                    targetIndex = mapStackSwitch[sourceEntry.sortGroup].findIndex(layerId =>
                        service.layers.hasOwnProperty(layerId));
                    targetIndex = targetIndex !== -1 ? targetIndex : mapStackSwitch[sourceEntry.sortGroup].length;

                // if the layer is dropped on another layer in its sort group, get index of that layer
                } else if (sourceEntry.sortGroup === targetEntry.sortGroup) {
                    // get the index of the target layer in the appropriate map stack
                    targetIndex = mapStackSwitch[sourceEntry.sortGroup].indexOf(targetId);

                    // need to add 1 when moving layer up in the legend (down in the map stack)
                    targetIndex += sourceIndex > targetIndex ? 1 : 0;
                } else {
                    // TODO: I'm not sure what happened; unforseen condition
                    throw new Error('Halp!');
                }

                return targetIndex;
            }

            /**
             * Move a source layer within the map on top (visually) of the target layer.
             *
             * NOTE this does not modify the legend, movement within the legend should be handled separately, ideally
             * calling this function immediately before or after the legend is updated.
             *
             * IMPORTANT NOTE: targetId __must__ be the id of the layer which is actually in the map stack; this can't be a placholder which is not added to the map object.
             *
             * @function moveLayer
             * @param {String} sourceId the id of the layer to be moved
             * @param {String} targetId the id of the layer the target layer will be moved on top of; can be -1, if its the end of the list
             */
            function moveLayer(sourceId, targetId) {
                const sourceLayer = service.layers[sourceId]._layer;
                const targetIndex = getLayerInsertPosition(sourceId, targetId);

                _testSyncCheck();

                // console.log(`reodder ${sourceId} on ${targetIndex}`);
                mapObject.reorderLayer(sourceLayer, targetIndex);
            }

            /**
             * This is temporary function to make sure the mapstack and legend is in sync;
             * @function _testSyncCheck
             * @private
             */
            function _testSyncCheck() {
                // remove all layer id from the map stacks which are not present in the legend
                const fullMapStack =
                    [].concat(mapObject.graphicsLayerIds.slice().reverse(), mapObject.layerIds.slice().reverse())
                    .filter(layerId => service.layers.hasOwnProperty(layerId));

                // remove all layer ids from the legend which are not preset in the map stack
                const fullLegendStack = service.legend.items
                    .filter(entry => _refactorIsLayerInMapStack(entry.id, entry.sortGroup))
                    .map(entry => entry.id);

                // compare the order of layer ids in both arrays - they should match
                fullMapStack.forEach((layerId, index) => {
                    if (fullLegendStack[index] !== layerId) {
                        console.error('Map stack is out of ~~whack~~ sync!');
                        console.warn('fullMapStack', fullMapStack);
                        console.warn('fullLegendStack', fullLegendStack);
                        return;
                    }
                });

                console.log('Map stack is in sync with legend');
            }

            /**
             * Set the visibility of the bounding box for the specified layer.
             * FIXME this should move into a method on LegendEntry
             * @function setBboxState
             * @param {Object} layerEntry the layer entry used to generate the bounding box
             * @param {Boolean} visible the visibility state of the bounding box,
             * it is permitted to attempt to transition from true->true or false->false
             * these transitions will be ignored by the method
             */
            function setBboxState(layerEntry, visible) {
                const layerRecord = layers[layerEntry.id];
                if (!visible) {
                    if (layerRecord.bbox) {
                        layerRecord.destroyBbox(mapObject);
                    }
                    return;
                }
                if (layerRecord.bbox) {
                    return;
                }
                layerRecord.createBbox(mapObject);
            }

            /**
             * Creates esri layer object for a set of layer config objects, triggers attribute loading on layer load event and adds it to the legend afterwards.
             * @function constructLayers
             * @param  {Array} layerBlueprints array of layer configuration objects
             */
            function constructLayers(layerBlueprints) {
                layerBlueprints.forEach(layerBlueprint => {
                    // get the layer config from blueprint
                    // TODO: decouple identifyservice from everything
                    layerBlueprint.generateLayer().then(lr => {
                        registerLayerRecord(lr);
                        const pos = createPlaceholder(lr);
                        console.log(`adding ${lr.config.name} to map at ${pos}`);
                        lr.addStateListener(makeFirstLoadHandler(lr));
                        mapObject.addLayer(lr._layer, pos);
                        // HACK: for a file-based layer, call onLoad manually since such layers don't emmit events
                        if (lr._layer.loaded) {
                            lr.onLoad();
                            lr.onUpdateEnd();
                        }
                    });
                });
            }

            // this should be in legend service
            // it should bind layerRecord.legendEntry after creating the placeholder
            function createPlaceholder(lr) {
                const sourceIndex = ref.legendService.addPlaceholder(lr);
                let targetId = service.legend.items[sourceIndex + 1];

                // FIXME: remove 'placeholder' part of the id; should be fixed by refactor - split layer id and legend id on legend entry
                targetId = typeof targetId === 'undefined' ? targetId : targetId.id.replace('placeholder', '');
                return getLayerInsertPosition(lr.layerId, targetId);

            }

            // FIXME add docs
            function makeFirstLoadHandler(lr) {
                const firstListener = state => {
                    if (state !== Geo.Layer.States.LOADED) { return; }
                    lr.removeStateListener(firstListener);
                    const opts = lr.legendEntry.options;
                    if (opts.hasOwnProperty('boundingBox') &amp;&amp; opts.boundingBox.value) {
                        setBboxState(lr.legendEntry, true);
                    }
                    const wkid = geoState.mapService.mapObject.spatialReference.wkid;
                    if (lr.config.layerType === 'esriTile' &amp;&amp; lr._layer.spatialReference.wkid !== wkid) {
                        opts.visibility.enabled = false;
                        opts.visibility.value = false;
                    }
                    setScaleDepState(lr.layerId);
                };
                return firstListener;
            }

            /**
             * Removes the layer from the map and from the layer registry; This will not remove the corresponding legend entry.
             * @function removeLayer
             * @param {Number} layerId  the id of the layer to be removed
             * TODO: needs more work for removing dynamic layers and its children;
             */
            function removeLayer(layerId) {
                const l = layers[layerId];

                // TODO: don't fail silently; throw an error; maybe shown message to the user.
                if (!l) {
                    throw new Error();
                }

                if (l.bbox) {
                    l.destroyBbox(mapObject);
                }

                mapObject.removeLayer(l._layer);
                delete service.layers[layerId]; // remove layer from the registry
            }

            /**
             * Zoom to visibility scale.
             * @function zoomToScale
             * @param {Number} layerId  the id of the layer to zoom to scale to
             * @param {Boolean} zoomIn the zoom to scale direction; true need to zoom in; false need to zoom out
             *
             */
            function zoomToScale(layerId, zoomIn) {
                const l = layers[layerId]._layer;
                const lods = zoomIn ? geoState.lods : [...geoState.lods].reverse();
                const lod = lods.find(lod => zoomIn ? lod.scale &lt; l.minScale : lod.scale > l.maxScale);
                return mapObject.setScale(lod.scale);
            }

            /**
             * Reload a layer.  Can accept LayerRecords or LegendEntries.
             * @function reloadLayer
             * @param {LayerRecord|LegendEntry} l the layer to be reloaded
             * @param {Function} configUpdate an optional function which will be passed the configuration
             *                   of the given layer and can make changes before the new layer is loaded
             */
            function reloadLayer(l, configUpdate) {
                // FIXME do a proper test when LegendEntry becomes a proper class
                const lr = l._layerRecord || l;
                const pos = getLayerMapIndex(lr);
                mapObject.removeLayer(lr._layer);
                if (configUpdate) {
                    configUpdate(lr.config);
                }
                mapObject.addLayer(lr.constructLayer(), pos);
            }

            /**
             * Switch a feature layer to snapshot mode.
             * @function snapshotLayer
             * @param {LayerRecord|LegendEntry} l the layer to be reloaded
             */
            function snapshotLayer(l) {
                const configUpdate = cfg => cfg.options.snapshot.value = true;
                reloadLayer(l, configUpdate);
            }

            /**
             * Register a LayerRecord object within this service.  Is added the `layers` object internally.
             * Layer IDs must be unique.
             * @function registerLayerRecord
             * @param {LayerRecord} lr
             */
            function registerLayerRecord(lr) {
                if (!lr.layerId) {
                    throw new Error('Attempt to register layer without id property');
                }
                if (layers[lr.layerId]) {
                    throw new Error(`Attempt to register layer already registered.  id: ${lr.layerId}`);
                }
                service.layers[lr.layerId] = lr;
            }

            /**
             * Get the best user-friendly name of a field. Uses alias if alias is defined, else uses the system attribute name.
             * @function aliasedFieldName
             * @param {String} attribName the attribute name we want a nice name for
             * @param {Object} fields array of field definitions. the attribute should belong to the provided set of fields
             */
            function aliasedFieldName(attribName, fields) {
                let fName = attribName;

                // search for aliases
                if (fields) {
                    const attribField = fields.find(field => {
                        return field.name === attribName;
                    });
                    if (attribField &amp;&amp; attribField.alias &amp;&amp; attribField.alias.length > 0) {
                        fName = attribField.alias;
                    }
                }
                return fName;
            }

            /**
             * Check to see if the attribute in question is an esriFieldTypeDate type.
             * FIXME refactor and move to geoapi
             * @function checkDateType
             * @param {String} attribName the attribute name we want to check if it's a date or not
             * @param {Array} fields array of field definitions. the attribute should belong to the provided set of fields
             * @return {Boolean} returns true or false based on the attribField type being esriFieldTypeDate
             */
            function checkDateType(attribName, fields) {
                if (fields) {
                    const attribField = fields.find(field => {
                        return field.name === attribName;
                    });
                    if (attribField &amp;&amp; attribField.type) {
                        return attribField.type === 'esriFieldTypeDate';
                    }
                }
                return false;
            }
        }
    }
})();
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jul 11 2016 01:39:06 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
